function removeTag(b){var a=document.createDocumentFragment();while(b.firstChild){a.appendChild(b.firstChild)}b.parentNode.insertBefore(a,b);b.parentNode.removeChild(b)}function canHaveBlockElement(a){var b={blockquote:0,div:0,form:0,td:0};return(a.tagName.toLowerCase() in b)}var domiwyg={tool_btns:[["Source","toggle_src"],["Link","create_link"],["Image","insert_image"],["Ulist","insert_ul"],["Olist","insert_ol"],["Table","insert_table"]],styles:[["<p></p>",1,"tag_p"],["<h1></h1>",1,"tag_h1"],["<h2></h2>",1,"tag_h2"],["<h3></h3>",1,"tag_h3"],["<h4></h4>",1,"tag_h4"],["<h5></h5>",1,"tag_h5"],["<h6></h6>",1,"tag_h6"],["<blockquote></blockquote>",1,"tag_blockquote"]],allowed:{a:{href:0},blockquote:{},div:{},em:{},h1:{},h2:{},h3:{},h4:{},h5:{},h6:{},img:{alt:0,src:0},li:{},ol:{},p:{},span:{},strong:{},table:{},tr:{},td:{},ul:{}},allowed_global:{"class":0,id:0,title:0},lang:{err_format_support1:"The format command ",err_format_support2:" was not supported by your browser.",err_number_format:"You must enter a number.",toggle_src:"Toggle source editing",create_link:"Create/edit link",insert_image:"Insert image",insert_ul:"Insert unordered list",insert_ol:"Insert ordered list",insert_table:"Insert table",ok:"OK",cancel:"Cancel",info_link_dlg:"Write the address to where the link will lead. Also choose which protocol that should be used.",same_site:"within same site",website:"website",secure_site:"secure site",email:"e-mail",filetransfer:"file transfer",info_link_delete:"If you want to remove a link, select the <strong>entire</strong> link and leave the above field empty.",info_image_dlg:"Write the address to the image.",image_url:"Image URL",num_rows:"Number of rows",num_cols:"Number of columns",no_elem_active:"(no element selected)",tag_a:"Link",tag_blockquote:"Blockquote",tag_div:"Container",tag_em:"Emphasized",tag_h1:"Header 1",tag_h2:"Header 2",tag_h3:"Header 3",tag_h4:"Header 4",tag_h5:"Header 5",tag_h6:"Header 6",tag_img:"Image",tag_li:"List element",tag_ol:"Ordered list",tag_p:"Paragraph",tag_span:"Span",tag_strong:"Strong",tag_table:"Table",tag_tr:"Table row",tag_td:"Table cell",tag_ul:"Unordered list",cssclass:"Class",select_style:"-- Select a style --"},find:function(){var a=document.getElementsByTagName("textarea"),c,b,d;for(c=0;c<a.length;c++){b=a[c];if(b.className.indexOf("use-domiwyg")>-1){d=b.parentNode.insertBefore(toDOMnode('<div id="domiwyg_'+b.id+'" class="domiwyg-app"></div>'),b);b.domiwyg=new domiwyg.area(b,d);b.className=b.className.replace(/\buse-domiwyg\b/,"has-domiwyg")}}},area:function(a,d){var c=domiwyg,b=this;b.textarea=a;b.domcrumbs=null;b.app=d;b.domarea=null;b.source_editor=null;b.cur_elm=null;b.caret=null;b.save=c.save;b.sanitize=c.sanitize;b.prettyHtml=c.prettyHtml;b.init=c.init;b.clicking=c.clicking;b.updateDomCrumbs=c.updateDomCrumbs;b.addStylingElement=c.addStylingElement;b.keyStrokes=c.keyStrokes;b.storeCursor=c.storeCursor;b.restoreCursor=c.restoreCursor;b.nodeInArea=c.nodeInArea;b.getSelectedAreaElement=c.getSelectedAreaElement;b.getFirstContainer=c.getFirstContainer;b.format=c.format;b.cmdSource=c.cmdSource;b.cmdLink=c.cmdLink;b.createLink=c.createLink;b.cmdImage=c.cmdImage;b.insertImage=c.insertImage;b.cmdUlist=c.cmdUlist;b.cmdOlist=c.cmdOlist;b.cmdTable=c.cmdTable;b.insertTable=c.insertTable;b.init()},save:function(){var a=this;if(!hasClass(a.source_editor,"hidden")){a.domarea.innerHTML=a.source_editor.value}a.sanitize();return a.prettyHtml()},sanitize:function(){var e=domiwyg,g=this.domarea.getElementsByTagName("*"),j,i,h,d,b,f;for(j=0;j<g.length;j++){i=g[j];h=i.tagName.toLowerCase();if(!(h in e.allowed)){removeTag(i);--j;continue}else{if(h!="img"&&!i.childNodes.length){i.parentNode.removeChild(i)}}d=i.attributes;i.removeAttribute("style");for(b=0;b<d.length;b++){f=d[b].name;if(!(f in e.allowed[h])&&!(f in e.allowed_global)){i.removeAttribute(f)}}}},prettyHtml:function(b){var a=this.domarea.innerHTML.replace(/<\/?(\w+)((?:[^'">]*|'[^']*'|"[^"]*")*)>/g,function(d,f,c){c=c.replace(/(\w+)(=+)(\w+)/g,'$1$2"$3"');f=f.toLowerCase();var e=(d.match(/^<\//));if(e){d="</"+f+">"}else{d="<"+f+c+">"}return d});return a.replace(/<img([^>]*)>/ig,"<img$1 />")},init:function(){var j=this,c=j.app,h,i,a=domiwyg,b=a.lang,e=a.tool_btns,d=a.styles,f='<select class="domiwyg-styles-list"><option value="-1">'+b.select_style+"</option>",g;for(i=0;i<d.length;i++){f+='<option value="'+i+'">'+b[d[i][2]]+"</option>"}f+="</select>";for(i=0;i<e.length;i++){f+='<button class="dwcmd-'+e[i][0]+'" title="'+b[e[i][1]]+'">'+b[e[i][1]]+"</button>"}g=c.appendChild(toDOMnode('<div class="domiwyg-toolbar">'+f+"</div>"));j.domcrumbs=c.appendChild(toDOMnode('<div class="domiwyg-dom-crumbs">&nbsp;</div>'));h=j.domarea=c.appendChild(toDOMnode('<div class="domiwyg-area" contenteditable="true"></div>'));j.source_editor=c.appendChild(toDOMnode('<textarea class="domiwyg-source-editor hidden"></textarea>'));h.innerHTML=j.textarea.value;j.sanitize();addEvent(c,"click",j.clicking,j);addEvent(c,"keyup",j.keyStrokes,j);addEvent(h,"click",j.updateDomCrumbs,j);addEvent(h,"focus",function(){addClass(c,"focus")});addEvent(h,"blur",function(){removeClass(c,"focus")});addEvent(h,"keyup",j.updateDomCrumbs,j);addEvent(g.getElementsByTagName("select")[0],"change",j.addStylingElement,j)},clicking:function(d){var b=getTarget(d),a=b.className,c;returnFalse(d);if(a.indexOf("dwcmd-")>-1){c=a.indexOf(" ");this["cmd"+a.substring(6,(c>0?c:undefined))](b)}addClass(this.app,"focus")},updateDomCrumbs:function(g){var i=this,d=getTarget(g),f=[],c,h,b=domiwyg.lang,j,a;if(g.keyCode){d=i.getSelectedAreaElement()}if(i.cur_elm!=d){i.cur_elm=d;while(!hasClass(d,"domiwyg-area")){h=d.tagName.toLowerCase();c="tag_"+h;if(c in b){h=b[c]}j=(d.className?b.cssclass+": "+d.className+" ":"");a=(d.id?"ID: "+d.id:"");f.push("<span"+(j||a?' title="'+j+a+'"':"")+">"+h+"</span>");d=d.parentNode}f.reverse();f=f.join(" &gt; ");i.domcrumbs.innerHTML=(f||b.no_elem_active)}},addStylingElement:function(h){var b=this,g=getTarget(h),f=domiwyg.styles[g.value]||null,a,d,i,c;if(f){if(window.getSelection){a=window.getSelection().getRangeAt(0);d=a.extractContents()||document.createDocumentFragment();i=toDOMnode(f[0]);i.appendChild(d);if(f[1]){c=a.startContainer;if(hasClass(c,"domiwyg-area")){a.insertNode(i)}else{c=b.getFirstContainer(c);c.container.insertBefore(i,c.reference)}}else{a.insertNode(i)}}else{if(document.selection){a=document.selection.createRange();i=toDOMnode(f[0]);if(a.htmlText){i.appendChild(toDOMnode(a.htmlText));if(f[1]){c=b.getFirstContainer(a.parentElement());c.container.insertBefore(i,c.reference);a.pasteHTML("")}else{a.pasteHTML(i.innerHTML)}}else{c=a(0);i.appendChild(c.cloneNode(1));c.parentNode.insertBefore(i,c);c.parentNode.removeChild(c)}}}}g.value=-1},keyStrokes:function(c){var b=(c.keyCode?c.keyCode:c.charCode),a=this;if(c.ctrlKey&&b==86){a.storeCursor();setTimeout(function(){a.sanitize();a.restoreCursor()},100)}},storeCursor:function(){if(window.getSelection){var a=window.getSelection();this.caret={anchorNode:a.anchorNode,anchorOffset:a.anchorOffset,focusNode:a.focusNode,focusOffset:a.focusOffset}}else{if(document.selection){this.caret=document.selection.createRange().getBookmark()}}},restoreCursor:function(){var b,a=this,c=a.caret;if(window.getSelection){b=document.createRange();b.setStart(c.anchorNode,c.anchorOffset);b.setEnd(c.focusNode,c.focusOffset);window.getSelection().addRange(b)}else{if(document.selection){b=document.selection.createRange();b.moveToBookmark(c);b.select()}}a.caret=null},nodeInArea:function(a){while(a.nodeName.toLowerCase()!="body"){if(a==this.domarea){return 1}a=a.parentNode}return 0},getSelectedAreaElement:function(){var b,a=null;if(window.getSelection){b=window.getSelection();if(this.nodeInArea(b.focusNode)){a=b.focusNode.parentNode}}else{if(document.selection){b=document.selection.createRange();a=b.parentElement();if(!this.nodeInArea(a)){a=null}}}return a},getFirstContainer:function(b){var a=b;b={container:b,reference:null};while(1){if(a.nodeType==1&&canHaveBlockElement(a)){break}b.reference=b.container;a=b.container=a.parentNode}return b},format:function(b,a){if(typeof a=="undefined"){a=null}try{document.execCommand(b,0,a)}catch(c){alert(domiwyg.lang.err_format_support1+b+domiwyg.lang.err_format_support2)}this.domarea.focus()},cmdSource:function(b){var a=this,c=a.domarea,d=a.source_editor;if(hasClass(b,"active")){c.innerHTML=d.value;a.sanitize();removeClass(b,"active");removeClass(c,"hidden");addClass(d,"hidden");c.focus()}else{d.value=a.prettyHtml();addClass(b,"active");addClass(c,"hidden");removeClass(d,"hidden");d.focus()}},cmdLink:function(){var b=this,f=domiwyg.lang,c=b.getSelectedAreaElement(),a=null,e,d;if(c){a=c.nodeName.toLowerCase();b.storeCursor();boxing.show("<h1>"+f.create_link+"</h1><p>"+f.info_link_dlg+'</p><p><select id="dw_link_protocol">    <option value="">'+f.same_site+'</option>    <option value="http:">http: ('+f.website+')</option>    <option value="https:">https: ('+f.secure_site+')</option>    <option value="mailto:">mailto: ('+f.email+')</option>    <option value= "ftp:">ftp: ('+f.filetransfer+')</option>  </select> <input type="text" id="dw_link_url" value="www.example.com" /></p><p>'+f.info_link_delete+'</p><p><button id="btn_create_link" class="hide-boxing">'+f.ok+'</button> <button class="hide-boxing">'+f.cancel+"</button></p>",400,190);elem("dw_link_url").focus();if(a){if(a=="a"){e=c.getAttribute("href");if(e.indexOf(":")<0||e.indexOf(":")>6){elem("dw_link_protocol").value="";elem("dw_link_url").value=e}else{d=e.indexOf(":")+1;elem("dw_link_protocol").value=e.substring(0,d);elem("dw_link_url").value=e.substring(d)}}else{c=null}addEvent(elem("btn_create_link"),"click",function(){b.createLink(c)})}else{boxing.hide()}}},createLink:function(c){var a=this,d=elem("dw_link_protocol").value,b=elem("dw_link_url").value;a.restoreCursor();if(b==""){if(c){removeTag(c)}}else{b=b.replace(/^[a-z]{3,6}:(\/\/)?/ig,"");if(d!="mailto:"&&d!=""&&b.indexOf("//")!=0){b="//"+b}if(c){c.setAttribute("href",d+b)}else{setTimeout(function(){a.format("createlink",d+b)},100)}}},cmdImage:function(){var a=this,b=domiwyg.lang;if(a.getSelectedAreaElement()){a.storeCursor();boxing.show("<h1>"+b.insert_image+"</h1><p>"+b.info_image_dlg+"</p><p>"+b.image_url+': <input type="text" id="dw_img_url" value="" /></p><p><button id="btn_insert_image" class="hide-boxing">'+b.ok+'</button> <button class="hide-boxing">'+b.cancel+"</button></p>",400,110);elem("dw_img_url").focus();addEvent(elem("btn_insert_image"),"click",a.insertImage,a)}},insertImage:function(){var a=elem("dw_img_url").value;this.restoreCursor();if(a!=""){this.format("insertimage",a)}},cmdUlist:function(){this.format("insertunorderedlist")},cmdOlist:function(){this.format("insertorderedlist")},cmdTable:function(){var a=this,c=domiwyg.lang,b=a.getSelectedAreaElement();if(b){a.storeCursor();boxing.show("<h1>"+c.insert_table+'</h1><p class="domiwyg-form"><label for="dw_num_rows">'+c.num_rows+':</label> <input type="text" id="dw_num_rows" value="" />  <label for="dw_num_cols">'+c.num_cols+':</label> <input type="text" id="dw_num_cols" value="" /></p><p><button id="btn_insert_table" class="hide-boxing">'+c.ok+'</button> <button class="hide-boxing">'+c.cancel+"</button></p>",400,110);elem("dw_num_rows").focus();addEvent(elem("btn_insert_table"),"click",function(){a.insertTable(b)})}},insertTable:function(d){var j=parseInt(elem("dw_num_rows").value,10),g=parseInt(elem("dw_num_cols").value,10),h=document,a,e,i=h.createElement("table"),f,b;this.restoreCursor();if(j>0&&g>0){for(a=0;a<j;a++){f=h.createElement("tr");i.appendChild(f);for(e=0;e<g;e++){b=h.createElement("td");b.appendChild(h.createTextNode("Cell"));f.appendChild(b)}}d=this.getFirstContainer(d);d.container.insertBefore(i,d.reference)}}};